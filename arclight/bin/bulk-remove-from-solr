#!/bin/bash -e

# This script takes as an argument the name of a key
# in s3://$S3_BUCKET/removals/ containing a csv list
# of finding aid ID, repository code pairs to delete,
# and deletes the finding aids from solr

# check that we have an s3 key
if [ -z "$1" ]; then
    echo "Usage: $0 <s3_key>"
    exit 1
fi

# check that the S3_BUCKET environment variable is set
if [ -z "$S3_BUCKET" ]; then
    echo "The S3_BUCKET environment variable must be set"
    exit 1
fi

echo "Downloading S3 file $S3_BUCKET/$1 to /tmp/$1"
aws s3 cp s3://"$S3_BUCKET"/removals/"$1" /tmp/"$1"

queries=""
# Initialize array for cache invalidation paths
INVALIDATION_PATHS=()

while IFS=, read -r findaid_id repo_code || [ -n "$findaid_id" ]
do
    # Trim leading/trailing whitespace
    findaid_id="${findaid_id##*( )}"
    findaid_id="${findaid_id%%*( )}"
    escaped_findaidid="${findaid_id//\:/\\\:}"
    escaped_findaidid="${escaped_findaidid//\//\\\/}"
    queries+="<query>_root_:$escaped_findaidid</query>"

    # Add to invalidation paths array
    if [ ! -z "$findaid_id" ]; then
        INVALIDATION_PATHS+=("/findaid/$findaid_id*")
    fi
done < "/tmp/$1"

curl -X POST "$SOLR_WRITER/update?commit=true" \
    -H "Content-Type: text/xml" \
    --data-binary "<delete>$queries</delete>"

echo "Finished deleting finding aids from arclight"
echo "Now creating a cache invalidation for each page and their repositories"

# Run cache invalidation once for all paths
if [ ${#INVALIDATION_PATHS[@]} -gt 0 ] && [ ${#INVALIDATION_PATHS[@]} -lt 10 ]; then
    if [ -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
        echo "CLOUDFRONT_DISTRIBUTION_ID not set, skipping cache invalidation."
    else
        echo "Running cache invalidation for ${#INVALIDATION_PATHS[@]} paths"
        echo "Invalidating urls: ${INVALIDATION_PATHS[*]}"
        cf=$(aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "${INVALIDATION_PATHS[@]}")
        echo "Invalidation submitted: $cf"
    fi
else
    echo "Too few or too many invalidation paths (${#INVALIDATION_PATHS[@]}), skipping cache invalidation."
fi
