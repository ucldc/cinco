# OAC Arclight - Public front end for OAC

## Local dev in Docker

```
docker compose -f docker-compose.dev.yaml build
docker compose -f docker-compose.dev.yaml up
```

## Local dev with local Ruby/Rails and solr running in Docker

NOTE: following these instructions will run Solr using the arclight/blacklight defaults, rather than with the customizations we have made for cinco. To run solr using the cinco config, follow the `Local dev in Docker` instructions above.

You'll need Ruby available, the version specificed in (.ruby-version)[.ruby-version]. You probably want to manage yourt rubies with a tool like rbenv

You'll also need to create a file in the config directory named `master.key` with a shared value that can be provided to you by another developer on the team.

On those dependencies are satified, run the following commands:
```
# install dependenices
bundle

# run db migrations
bundle exec rails db:migrate

# start solr
docker compose up -d

# start the rails server
bundle exec rails s
```

## Indexing

To run the indexer with our customizations use the following command from the arclight root. NOTE that this assumes you are running the arclight app locally, not in docker:

```
bundle exec traject -I lib/ -u http://<solr_url>:8983/solr/blacklight-core -i xml -c lib/arclight/traject/ead2_config.rb path/to/file.xml
```

You should be able to run the above command in docker also, using something like:

```
docker exec arclight-app-1 bundle exec traject -I lib/ -u http://solr_follower:8983/solr/arclight -i xml -c lib/arclight/traject/ead2_config.rb path/to/file.xml
```

** Settings
Settings can be added to the index command with `-s name=value`

`preview` - if an item is being previewed rather than published set to "true" `-s preview=true` (default: false)
`ark` - set to the ark generated by cincoctrl, this will be the url of the item in arclight `-s ark=xxXXXXXX`
`eadid` (required) - for OAC5 this should be set to the filename in s3 for EADs and to the collection number/unitid for record express and marc

** Environment variables
`REPOSITORY_ID` - Must be set to Repository.code (from cincoctrl) to add to a repository in arclight (no default)
`TEXT_FILE_NAME` (Optional)- May be set to change the name of the the file that contains extracted text (default: `extracted-supplementary-files-text.txt`)
`TEXT_FILE_DIR` (Optional)- May be set to change the directory where the text file is located (default: same directory as the XML)

## Caching for Static Finding Aids

We use Rails Solid cache to speed up generation of static finding aid pages. Some static finding aids are too big to even render an initial time as they will time out at the Load Balancer. So, we have a rake task that can be run from the command line in a rails container to generate the cache internally, bypassing the load balancer.

`bin/rake cache:generate_for[ark:/13030/8ac9sjfq4d]`

Additionally, when users start to update finding aids, we will need a way to invalidate cached pages. So, there is an additionl rake task to clear the cache by guide id

`bin/rake cache:clear_for[ark:/13030/8ac9sjfq4d]`

## Running the tests

We test the application with [rspec](https://rspec.info/).

`bundle exec rspec` will run all of the rspec tests.

`bundle exec rspec spec/components/my_component_spec.rb` will run just the tsts in that file.

## Linting

We run rubocop as part of the pre-commit configuration. By default, it only runs on the diff between the current commit and the previous commit. If you need to to run on the entire codebase, you can run it manually with `bundle exec rubocop -a`


## Test data fixture

From local machine, run test data load script in arclight container:

```
docker exec arclight-app-1 bash -c "./bin/load_dev_fixtures.sh"
```

## Indexing documents

Example indexing EAD in local dev environment (from arclight container):

```
export REPOSITORY_ID=ampas_clac
bundle exec traject -I lib/ -u $SOLR_WRITER -i xml -c lib/arclight/traject/ead2_config.rb files/xml/finding-aid.xml -s ark=ark:/13030/c8ht2mq2 -s eadid="filename.xml"
```

Example indexing marc in local dev environment (from arclight container):

```
export SOLR_WRITER="http://arclight-local_dev_solr_leader-1:8983/solr/arclight"
export REPOSITORY_ID=ucdavis_spcoll
bundle exec traject -I lib/ -u $SOLR_WRITER -i marc -c lib/arclight/traject/marc_config.rb files/marc/UC_Davis.Shields.mrc
```

## Code layout

The only modifications we've made to traject indexing are contained in the 3 configuration files in `/lib/arclight/traject/`:

```
marc_config.rb
ead2_config.rb
ead2_component_config.rb
```

The marc and ead base configs are invoked directly through the index commands, the ead component config is called by the ead base config.

There are some normalization related classes found in `lib/oac/`

## Indexing example queries

```
# Get collection record by id
curl "http://localhost:8983/solr/arclight/select?indent=on&q=id:ark\:\/13030\/kt3g50111g&wt=json"

# Get all components by collection level id
curl "http://localhost:8983/solr/arclight/select?indent=on&q=id:ark\:\/13030\/kt3g50111g*&wt=json"
curl "http://localhost:8983/solr/arclight/select?indent=on&q=_root_:ark\:\/13030\/kt3g50111g&wt=json"

# Get institution level collection published item counts
curl "http://localhost:8983/solr/arclight/select?indent=on&q=level_ssim:Collection&facet.field=repository_ssim&facet.limit=500&fq=preview_ssi:false&rows=0&wt=json"

# Get all collection level ids
curl "http://localhost:8983/solr/arclight/select?indent=on&q=level_ssim:Collection&fl=id&wt=json"
```
